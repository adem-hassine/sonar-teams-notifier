FROM sonarqube:9.1-community
# setup ssh 
RUN apk add openssh procps openrc supervisor --no-cache && echo "root:root" | chpasswd && echo "PermitRootLogin Yes " >> /etc/ssh/sshd_config && rc-update add sshd && rc-status && $(/etc/init.d/sshd start || true) && touch /run/openrc/softlevel 
# fixing sonarqube user (user not availabe since no shell is allocated for that user , and adding su to sudoers ) 
RUN apk add libuser --no-cache &&  touch /etc/login.defs && mkdir /etc/default && touch /etc/default/useradd && echo "sonarqube:sonar" | chpasswd && printf  "sonar\n/bin/bash" | lchsh sonarqube && chmod 4755 /bin/su 
# in order to get image with multiple entrypoint and we can controle the sonarqube server inside a dockerimage we need to add supervisor config 
COPY $CI_PROJECT_DIR/CICD-configs/Docker/supervisord.conf /etc/supervisord.conf
# add server controllers (for strat and shutdown)
COPY $CI_PROJECT_DIR/CICD-configs/Docker/shutdown-server.sh /home/root/shutdown-server.sh
COPY $CI_PROJECT_DIR/CICD-configs/Docker/start-server.sh /home/sonarqube/start-server.sh
CMD /usr/bin/supervisord -c /etc/supervisord.conf
#ENTRYPOINT ["tail", "-f", "/dev/null"]
#CMD $(/etc/init.d/sshd start || true ) && touch /run/openrc/softlevel && /etc/init.d/sshd start && /opt/sonarqube/bin/run.sh
#$(/etc/init.d/sshd start ; touch /run/openrc/softlevel ; /etc/init.d/sshd start)
